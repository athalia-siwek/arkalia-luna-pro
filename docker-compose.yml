# 📦 Arkalia Luna Pro — Docker Compose
# Version modulaire et professionnelle

x-arkalia-defaults: &arkalia-defaults
  build:
    context: .
  volumes:
    - .:/app
  working_dir: /app
  environment:
    - PYTHONUNBUFFERED=1
  restart: unless-stopped

services:

  # 🚀 Serveur principal Arkalia API (Helloria)
  arkalia-api:
    <<: *arkalia-defaults
    container_name: arkalia-api
    ports:
      - "${PORT_API:-8000}:${PORT_API:-8000}"
    command: >
      uvicorn helloria.core:app --host 0.0.0.0 --port ${PORT_API:-8000}
        --reload --reload-dir helloria
        --reload-exclude logs/ --reload-exclude docs/ --reload-exclude site/

  # 🧠 AssistantIA — IA contextuelle de navigation
  assistantia:
    <<: *arkalia-defaults
    container_name: assistantia
    build:
      context: .
      dockerfile: Dockerfile.assistantia
    ports:
      - "${PORT_ASSISTANTIA:-8001}:${PORT_ASSISTANTIA:-8001}"
    command: >
      uvicorn modules.assistantia.core:app --host 0.0.0.0 --port ${PORT_ASSISTANTIA:-8001}

  # 🔁 ReflexIA — Boucle adaptative réflexive
  reflexia:
    <<: *arkalia-defaults
    container_name: reflexia
    build:
      context: .
      dockerfile: Dockerfile-reflexia
    command: python run_reflexia.py
    restart: always
    depends_on:
      - assistantia

  # 🤖 ZeroIA — Service de décision autonome
  zeroia:
    <<: *arkalia-defaults
    build:
      context: .
      dockerfile: Dockerfile.zeroia
    container_name: zeroia
    image: arkalia-luna-zeroia
    command: python modules/zeroia/reason_loop.py
    depends_on:
      - reflexia
    healthcheck:
      test: [ "CMD-SHELL", "cat modules/zeroia/state/zeroia_state.toml || exit 1" ]
      interval: 30s
      timeout: 5s
      retries: 3
