# 📦 Arkalia Luna Pro — Docker Compose
# Version modulaire et professionnelle

x-arkalia-defaults: &arkalia-defaults
  build:
    context: .
  volumes:
    - .:/app
  working_dir: /app
  environment:
    - PYTHONUNBUFFERED=1
  restart: unless-stopped

services:

  # 🚀 Serveur principal Arkalia API (Helloria)
  arkalia-api:
    <<: *arkalia-defaults
    container_name: arkalia-api
    ports:
      - "${PORT_API:-8000}:${PORT_API:-8000}"
    command: >
      uvicorn helloria.core:app --host 0.0.0.0 --port ${PORT_API:-8000}
        --reload --reload-dir helloria
        --reload-exclude logs/ --reload-exclude docs/ --reload-exclude site/
    read_only: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

  # 🧠 AssistantIA — IA contextuelle de navigation
  assistantia:
    <<: *arkalia-defaults
    container_name: assistantia
    build:
      context: .
      dockerfile: Dockerfile.assistantia
    ports:
      - "${PORT_ASSISTANTIA:-8001}:${PORT_ASSISTANTIA:-8001}"
    command: >
      uvicorn modules.assistantia.core:app --host 0.0.0.0 --port ${PORT_ASSISTANTIA:-8001}
    read_only: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

  # 🔁 ReflexIA — Boucle adaptative réflexive
  reflexia:
    <<: *arkalia-defaults
    container_name: reflexia
    build:
      context: .
      dockerfile: Dockerfile-reflexia
    command: python run_reflexia.py
    depends_on:
      - assistantia
    read_only: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

  # 🤖 ZeroIA — Service de décision autonome
  zeroia:
    <<: *arkalia-defaults
    container_name: zeroia
    build:
      context: .
      dockerfile: Dockerfile.zeroia
    image: arkalia-luna-zeroia
    command: python modules/zeroia/reason_loop.py
    depends_on:
      - reflexia
    healthcheck:
      test: [ "CMD", "python", "modules/zeroia/healthcheck_zeroia.py" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    read_only: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
