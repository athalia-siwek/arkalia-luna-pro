# 📦 Arkalia Luna Pro — Docker Compose
# Version modulaire, professionnelle et sécurisée

x-arkalia-defaults: &arkalia-defaults
  build:
    context: .
  volumes:
    - .:/app
  working_dir: /app
  environment:
    - PYTHONUNBUFFERED=1
  restart: unless-stopped

services:

  # 🚀 Helloria — API centrale (FastAPI)
  arkalia-api:
    <<: *arkalia-defaults
    container_name: arkalia-api
    ports:
      - "${PORT_API:-8000}:${PORT_API:-8000}"
    command: >
      uvicorn helloria.core:app --host 0.0.0.0 --port ${PORT_API:-8000}
        --reload --reload-dir helloria
        --reload-exclude logs/ --reload-exclude docs/ --reload-exclude site/
    read_only: true
    cap_drop: [ ALL ]
    security_opt:
      - no-new-privileges:true

  # 🧠 AssistantIA — Navigation contextuelle
  assistantia:
    <<: *arkalia-defaults
    container_name: assistantia
    build:
      context: .
      dockerfile: Dockerfile.assistantia
    ports:
      - "${PORT_ASSISTANTIA:-8001}:${PORT_ASSISTANTIA:-8001}"
    command: >
      uvicorn modules.assistantia.core:app --host 0.0.0.0 --port ${PORT_ASSISTANTIA:-8001}
    read_only: true
    cap_drop: [ ALL ]
    security_opt:
      - no-new-privileges:true

  # 🔁 ReflexIA — Observateur cognitif réflexif
  reflexia:
    <<: *arkalia-defaults
    container_name: reflexia
    build:
      context: .
      dockerfile: Dockerfile-reflexia
    command: python run_reflexia.py
    depends_on:
      - assistantia
    read_only: true
    cap_drop: [ ALL ]
    security_opt:
      - no-new-privileges:true

  # 🤖 ZeroIA — Décisionneur autonome intelligent Enhanced v2.6.0
  zeroia:
    <<: *arkalia-defaults
    container_name: zeroia
    build:
      context: .
      dockerfile: Dockerfile.zeroia
    image: arkalia-luna-zeroia
    command: python scripts/demo_orchestrator_enhanced.py --mode daemon
    environment:
      - ZEROIA_HOLD_LOOP=true
    depends_on:
      - reflexia
    healthcheck:
      test: [ "CMD", "python", "-c", "print(\"ZeroIA Enhanced OK\")" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    read_only: true
    cap_drop: [ ALL ]
    security_opt:
      - no-new-privileges:true

  # 🧠 Sandozia — Intelligence Croisée Enterprise v2.6.0
  sandozia:
    <<: *arkalia-defaults
    container_name: sandozia
    build:
      context: .
      dockerfile: Dockerfile.sandozia
    image: arkalia-luna-sandozia
    command: python scripts/demo_sandozia.py --daemon
    environment:
      - SANDOZIA_ENV=production
      - SANDOZIA_MONITORING_ENABLED=true
    depends_on:
      - zeroia
      - reflexia
    healthcheck:
      test: [ "CMD", "python", "-c", "from modules.sandozia.core.sandozia_core import SandoziaCore; print('OK')" ]
      interval: 45s
      timeout: 10s
      retries: 3
      start_period: 20s
    read_only: true
    cap_drop: [ ALL ]
    security_opt:
      - no-new-privileges:true
