---
name: ğŸš€ Arkalia-LUNA CI/CD

on:
  push:
    branches: [ main, develop, dev-migration, refonte-stable ]
  pull_request:
    branches: [ main, develop, dev-migration, refonte-stable ]

env:
  PYTHON_VERSION: "3.10"
  COVERAGE_MIN: 28
  SECURITY_COVERAGE_MIN: 10
  PERFORMANCE_COVERAGE_MIN: 10
  CHAOS_COVERAGE_MIN: 10
  # Timeouts pour Ã©viter les jobs bloquÃ©s
  TEST_TIMEOUT: 1800  # 30 minutes
  BUILD_TIMEOUT: 900  # 15 minutes

# Permissions globales pour Ã©viter les erreurs de sÃ©curitÃ©
permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ğŸ” Linting et formatage
  lint:
    name: ğŸ” Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Pour avoir l'historique complet

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # Cache des dÃ©pendances

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install black isort ruff mypy bandit

      - name: ğŸ§¹ Clean generated files
        run: |
          find . -name "._*" -delete
          find . -name ".DS_Store" -delete
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name "*.pyc" -delete

      - name: ğŸ¨ Check code formatting
        run: |
          echo "ğŸ” VÃ©rification formatage avec black..."
          black --check --diff . || (echo "âŒ Formatage incorrect. ExÃ©cutez: black ." && exit 1)

          echo "ğŸ” VÃ©rification imports avec isort..."
          isort --check-only --diff . || (echo "âŒ Imports incorrects. ExÃ©cutez: isort ." && exit 1)

      - name: ğŸ” Run linting
        run: |
          echo "ğŸ” Linting avec ruff..."
          ruff check . --output-format=github || exit 1

          echo "ğŸ” Type checking avec mypy..."
          mypy modules/ --ignore-missing-imports --no-strict-optional || echo "âš ï¸ Type checking terminÃ© avec avertissements"

      - name: ğŸ”’ Security scan with bandit
        run: |
          echo "ğŸ”’ Scan de sÃ©curitÃ© avec bandit..."
          bandit -r modules/ -f json -o bandit-report.json || echo "âš ï¸ Scan de sÃ©curitÃ© terminÃ© avec avertissements"

      - name: ğŸ“‹ Upload linting artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: linting-artifacts
          path: |
            bandit-report.json
            .ruff_cache/

  # ğŸ§ª Tests unitaires et d'intÃ©gration
  test:
    name: ğŸ§ª Tests Unitaires & IntÃ©gration
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 30
    strategy:
      matrix:
        python-version: ["3.10"]
        os: [ubuntu-latest]
      fail-fast: false
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist pytest-timeout

      - name: ğŸ§¹ Clean test artifacts
        run: |
          find . -name "._*" -delete
          find . -name ".DS_Store" -delete
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          rm -f test-results.xml coverage.xml .coverage
          rm -rf htmlcov/ .pytest_cache/

      - name: ğŸ” Verify test environment
        run: |
          echo "ğŸ” VÃ©rification de l'environnement de test..."
          python --version
          pytest --version
          echo "ğŸ“ Tests disponibles:"
          find tests/ -name "test_*.py" | wc -l

      - name: ğŸ§ª Run unit tests with coverage
        run: |
          echo "ğŸ§ª ExÃ©cution des tests unitaires avec couverture..."
          pytest tests/unit/ \
            --cov=modules \
            --cov=scripts \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=${{ env.COVERAGE_MIN }} \
            --junitxml=test-results.xml \
            --timeout=300 \
            --tb=short \
            --ignore=modules/generative_ai/generated/ \
            --ignore=modules/security/sandbox/ \
            --ignore=modules/security/watchdog/ \
            --ignore=modules/helloria/main.py \
            --ignore=modules/helloria/state.py \
            --ignore=modules/utils_enhanced/core.py \
            --strict-markers \
            -v

      - name: ğŸ“Š Display coverage summary
        run: |
          echo "=== ğŸ“Š COUVERTURE DE TESTS ==="
          coverage report --show-missing
          echo "=== ğŸ“ FICHIERS COUVERTURE ==="
          ls -la coverage.xml htmlcov/ || echo "âš ï¸ Fichiers de couverture non trouvÃ©s"

      - name: ğŸ§ª Run integration tests (no coverage check)
        run: |
          echo "ğŸ§ª ExÃ©cution des tests d'intÃ©gration..."
          pytest -c pytest-integration.ini \
            --junitxml=integration-test-results.xml \
            --ignore=modules/generative_ai/generated/ \
            --timeout=300 \
            -v

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: ğŸ“‹ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
          path: |
            test-results.xml
            integration-test-results.xml
            htmlcov/
            .coverage
            coverage.xml
          retention-days: 30

  # ğŸ”’ Tests de sÃ©curitÃ©
  security:
    name: ğŸ”’ Tests de SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit safety

      - name: ğŸ”’ Run security tests
        run: |
          echo "ğŸ”’ ExÃ©cution des tests de sÃ©curitÃ©..."
          pytest -c pytest-security.ini --timeout=300 || echo "âš ï¸ Tests de sÃ©curitÃ© terminÃ©s avec avertissements"

      - name: ğŸ” Run bandit security scan
        run: |
          echo "ğŸ” Scan de sÃ©curitÃ© avec bandit..."
          bandit -r modules/ -f json -o bandit-report.json || echo "âš ï¸ Scan bandit terminÃ© avec avertissements"

      - name: ğŸ” Run safety check
        run: |
          echo "ğŸ” VÃ©rification des vulnÃ©rabilitÃ©s des dÃ©pendances..."
          safety check --json --output safety-report.json || echo "âš ï¸ Safety check terminÃ© avec avertissements"

      - name: ğŸ“‹ Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 90

  # ğŸš€ Tests de performance (nightly)
  performance:
    name: ğŸš€ Tests de Performance
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 20
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-benchmark

      - name: ğŸš€ Run performance tests
        run: |
          echo "ğŸš€ ExÃ©cution des tests de performance..."
          pytest -c pytest-performance.ini --timeout=600 || echo "âš ï¸ Tests de performance terminÃ©s avec avertissements"

      - name: ğŸ“Š Generate performance report
        run: |
          echo "ğŸ“Š GÃ©nÃ©ration du rapport de performance..."
          python scripts/ark-performance-benchmark.py --report-only || echo "âš ï¸ GÃ©nÃ©ration du rapport Ã©chouÃ©e"

      - name: ğŸ“‹ Upload performance artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-results
          path: |
            .benchmarks/
            performance-report.json
          retention-days: 30

  # ğŸŒ€ Tests de chaos (nightly)
  chaos:
    name: ğŸŒ€ Tests de Chaos
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 25
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸŒ€ Run chaos tests
        run: |
          echo "ğŸŒ€ ExÃ©cution des tests de chaos..."
          pytest -c pytest-chaos.ini --timeout=900 || echo "âš ï¸ Tests de chaos terminÃ©s avec avertissements"

      - name: ğŸ“‹ Upload chaos artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: chaos-results
          path: |
            chaos_reports/
            chaos_metric_*.toml
          retention-days: 30

  # ğŸ“Š Rapport final
  report:
    name: ğŸ“Š Rapport Final
    runs-on: ubuntu-latest
    needs: [test, security, performance, chaos]
    if: always()
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“‹ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ğŸ“Š Generate final report
        run: |
          {
            echo "## ğŸš€ Arkalia-LUNA CI/CD Report"
            echo "### ğŸ“… Date: $(date)"
            echo "### ğŸ”— Commit: ${{ github.sha }}"
            echo "### ğŸŒ¿ Branche: ${{ github.ref }}"
            echo "### ğŸƒâ€â™‚ï¸ Event: ${{ github.event_name }}"
            echo ""
            echo "### âœ… Tests Status"
            echo "- Unit & Integration: ${{ needs.test.result }}"
            echo "- Security: ${{ needs.security.result }}"
            echo "- Performance: ${{ needs.performance.result }}"
            echo "- Chaos: ${{ needs.chaos.result }}"
            echo ""
            echo "### ğŸ“ˆ Coverage: ${{ env.COVERAGE_MIN }}% minimum"
            echo "### â±ï¸ Timeouts: Test=${{ env.TEST_TIMEOUT }}s, Build=${{ env.BUILD_TIMEOUT }}s"
            echo ""
            echo "### ğŸ“‹ Artifacts Generated"
            ls -la artifacts/ || echo "Aucun artifact trouvÃ©"
          } > report.md

      - name: ğŸ“‹ Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: ci-report
          path: report.md
          retention-days: 90

      - name: ğŸš¨ Notify on failure
        if: failure()
        run: |
          echo "âŒ CI/CD a Ã©chouÃ© sur ${{ github.ref }}"
          echo "ğŸ”— Voir les dÃ©tails: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: ğŸ•µï¸ Validate mkdocs configuration
        run: |
          echo "ğŸ” Validation de la configuration MkDocs..."
          python -m pip install --upgrade pip setuptools wheel pipx
          python -m pipx ensurepath
          pipx install mkdocs
          pipx runpip mkdocs install mkdocs-material mkdocs-minify-plugin
          export PATH="$HOME/.local/bin:$PATH"
          if [ -f "mkdocs.yml" ]; then
            echo "âœ… mkdocs.yml trouvÃ©"
            mkdocs build --strict || echo "âš ï¸ mkdocs.yml invalide (non bloquant)"
          else
            echo "âš ï¸ mkdocs.yml manquant (non bloquant)"
          fi

  # ğŸ³ Build Docker Images
  build-docker:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 20
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ğŸ³ Build ZeroIA
        run: |
          if [ -f "Dockerfile.zeroia" ]; then
            docker build -f Dockerfile.zeroia -t arkalia-zeroia . || echo "âš ï¸ Construction ZeroIA Ã©chouÃ©e"
          else
            echo "âš ï¸ Dockerfile.zeroia non trouvÃ©"
          fi
      - name: ğŸ³ Build ReflexIA
        run: |
          if [ -f "Dockerfile.reflexia" ]; then
            docker build -f Dockerfile.reflexia -t arkalia-reflexia . || echo "âš ï¸ Construction ReflexIA Ã©chouÃ©e"
          else
            echo "âš ï¸ Dockerfile.reflexia non trouvÃ©"
          fi
      - name: ğŸ³ Build Sandozia
        run: |
          if [ -f "Dockerfile.sandozia" ]; then
            docker build -f Dockerfile.sandozia -t arkalia-sandozia . || echo "âš ï¸ Construction Sandozia Ã©chouÃ©e"
          else
            echo "âš ï¸ Dockerfile.sandozia non trouvÃ©"
          fi
      - name: ğŸ³ Build AssistantIA
        run: |
          if [ -f "Dockerfile.assistantia" ]; then
            docker build -f Dockerfile.assistantia -t arkalia-assistantia . || echo "âš ï¸ Construction AssistantIA Ã©chouÃ©e"
          else
            echo "âš ï¸ Dockerfile.assistantia non trouvÃ©"
          fi
      - name: ğŸ³ Build Cognitive Reactor
        run: |
          if [ -f "Dockerfile.cognitive-reactor" ]; then
            docker build -f Dockerfile.cognitive-reactor -t arkalia-cognitive-reactor . || echo "âš ï¸ Construction Cognitive Reactor Ã©chouÃ©e"
          else
            echo "âš ï¸ Dockerfile.cognitive-reactor non trouvÃ©"
          fi
      - name: ğŸ³ Build Generative AI
        run: |
          if [ -f "Dockerfile.generative-ai" ]; then
            docker build -f Dockerfile.generative-ai -t arkalia-generative-ai . || echo "âš ï¸ Construction Generative AI Ã©chouÃ©e"
          else
            echo "âš ï¸ Dockerfile.generative-ai non trouvÃ©"
          fi
      - name: ğŸ³ Build Master
        run: |
          if [ -f "Dockerfile.master" ]; then
            docker build -f Dockerfile.master -t arkalia-master . || echo "âš ï¸ Construction Master Ã©chouÃ©e"
          else
            echo "âš ï¸ Dockerfile.master non trouvÃ©"
          fi

  # ğŸ§ª Tests E2E
  e2e:
    name: ğŸ§ª Tests E2E
    runs-on: ubuntu-latest
    needs: build-docker
    timeout-minutes: 20
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx aiohttp
      - name: ğŸ³ Start services (docker-compose)
        run: |
          if [ -f "docker-compose.yml" ]; then
            docker-compose up -d || docker compose up -d || echo "âš ï¸ DÃ©marrage docker-compose Ã©chouÃ©"
            sleep 15
          else
            echo "âš ï¸ docker-compose.yml non trouvÃ©"
          fi
      - name: ğŸ§ª Run E2E tests
        run: |
          pytest tests/e2e/ --tb=short -v || echo "âš ï¸ Tests E2E terminÃ©s avec des Ã©checs (normal si services non disponibles)"
      - name: ğŸ³ Stop services
        if: always()
        run: |
          docker-compose down || docker compose down || echo "âš ï¸ Impossible d'arrÃªter les services"

  # ğŸš€ Deploy to Staging
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: e2e
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ğŸ³ Deploy to staging
        run: |
          if [ -f "docker-compose.prod.yml" ]; then
            docker-compose -f docker-compose.prod.yml up -d || docker compose -f docker-compose.prod.yml up -d || echo "âš ï¸ DÃ©ploiement staging Ã©chouÃ©"
          else
            echo "âš ï¸ docker-compose.prod.yml non trouvÃ©"
          fi
      - name: ğŸ§¹ Clean up
        if: always()
        run: |
          if [ -f "docker-compose.prod.yml" ]; then
            docker-compose -f docker-compose.prod.yml down || docker compose -f docker-compose.prod.yml down || echo "âš ï¸ Nettoyage staging Ã©chouÃ©"
          fi

  # ğŸ¥ Health Check
  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    timeout-minutes: 5
    steps:
      - name: ğŸ” Check API health
        run: |
          curl -f http://localhost:8000/health || echo "âš ï¸ API health non disponible"
      - name: ğŸ” Check metrics
        run: |
          curl -f http://localhost:8000/metrics || echo "âš ï¸ Metrics non disponible"
      - name: ğŸ” Check doc
        run: |
          curl -f http://localhost:9000 || echo "âš ï¸ Documentation non disponible"

  # ğŸš€ Deploy to Production (main uniquement, protÃ©gÃ©)
  deploy-prod:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [e2e, build-docker]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ steps.deployment.outputs.page_url }}
    timeout-minutes: 20
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ğŸ³ Deploy to production
        run: |
          if [ -f "docker-compose.prod.yml" ]; then
            docker-compose -f docker-compose.prod.yml up -d || docker compose -f docker-compose.prod.yml up -d || echo "âš ï¸ DÃ©ploiement production Ã©chouÃ©"
          else
            echo "âš ï¸ docker-compose.prod.yml non trouvÃ©"
          fi
      - name: ğŸ¥ Health Check (prod)
        run: |
          curl -f http://localhost:8000/health || echo "âš ï¸ API health non disponible"
          curl -f http://localhost:8000/metrics || echo "âš ï¸ Metrics non disponible"
      - name: ğŸ§¹ Clean up
        if: always()
        run: |
          if [ -f "docker-compose.prod.yml" ]; then
            docker-compose -f docker-compose.prod.yml down || docker compose -f docker-compose.prod.yml down || echo "âš ï¸ Nettoyage production Ã©chouÃ©"
          fi
