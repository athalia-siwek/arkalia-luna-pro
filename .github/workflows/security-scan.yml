name: ğŸ”’ Security Scan

on:
  push:
    branches: [main, dev-migration]
  pull_request:
    branches: [main, dev-migration]
  schedule:
    # Scan quotidien Ã  2h du matin
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write

env:
  PYTHON_VERSION: "3.10"
  SECURITY_SCAN_TIMEOUT: 600

jobs:
  security-scan:
    name: ğŸ” Security Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Pour l'historique complet des commits

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install security tools
        run: |
          pip install --upgrade pip
          pip install bandit safety pip-audit
          npm install -g audit

      - name: ğŸ” Python Security Scan (Bandit)
        run: |
          echo "ğŸ” Scanning Python code with Bandit..."
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f txt -o bandit-report.txt || true

          # VÃ©rifier si des vulnÃ©rabilitÃ©s critiques ont Ã©tÃ© trouvÃ©es
          if [ -f bandit-report.json ]; then
            CRITICAL_ISSUES=$(python -c "
            import json
            with open('bandit-report.json') as f:
                data = json.load(f)
            critical = sum(1 for result in data['results'] if result['issue_severity'] == 'HIGH')
            print(critical)
            ")
            if [ "$CRITICAL_ISSUES" -gt 0 ]; then
              echo "âŒ $CRITICAL_ISSUES vulnÃ©rabilitÃ©s critiques dÃ©tectÃ©es"
              exit 1
            fi
          fi

      - name: ğŸ” Dependency Security Scan (Safety)
        run: |
          echo "ğŸ” Scanning Python dependencies with Safety..."
          safety check --json --output safety-report.json || true
          safety check --output safety-report.txt || true

      - name: ğŸ” Dependency Security Scan (pip-audit)
        run: |
          echo "ğŸ” Scanning Python dependencies with pip-audit..."
          pip-audit --format json --output pip-audit-report.json || true
          pip-audit --output pip-audit-report.txt || true

      - name: ğŸ” Node.js Security Scan
        if: hashFiles('package.json') != ''
        run: |
          echo "ğŸ” Scanning Node.js dependencies..."
          npm audit --audit-level=high --json > npm-audit-report.json || true
          npm audit --audit-level=high > npm-audit-report.txt || true

      - name: ğŸ” Docker Security Scan
        run: |
          echo "ğŸ” Scanning Docker images for vulnerabilities..."
          # Scan des Dockerfiles pour les bonnes pratiques
          echo "ğŸ“‹ Checking Dockerfile best practices..."

          # VÃ©rifier les images de base
          grep -r "FROM" . --include="Dockerfile*" | grep -v "python:3.10-slim" | grep -v "node:" || echo "âœ… Base images look good"

          # VÃ©rifier les utilisateurs non-root
          grep -r "USER" . --include="Dockerfile*" || echo "âš ï¸ Some Dockerfiles might not use non-root users"

      - name: ğŸ“Š Upload Security Reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            *-report.json
            *-report.txt
          retention-days: 30

      - name: ğŸš¨ Security Summary
        run: |
          echo "ğŸ”’ SECURITY SCAN SUMMARY"
          echo "========================"

          # RÃ©sumÃ© Bandit
          if [ -f bandit-report.json ]; then
            echo "ğŸ“Š Bandit Results:"
            python -c "
            import json
            try:
                with open('bandit-report.json') as f:
                    data = json.load(f)
                issues = len(data.get('results', []))
                high = sum(1 for r in data.get('results', []) if r.get('issue_severity') == 'HIGH')
                medium = sum(1 for r in data.get('results', []) if r.get('issue_severity') == 'MEDIUM')
                low = sum(1 for r in data.get('results', []) if r.get('issue_severity') == 'LOW')
                print(f'  - Total issues: {issues}')
                print(f'  - High: {high}, Medium: {medium}, Low: {low}')
            except:
                print('  - No issues found or error reading report')
            "
          fi

          # RÃ©sumÃ© Safety
          if [ -f safety-report.json ]; then
            echo "ğŸ“Š Safety Results:"
            python -c "
            import json
            try:
                with open('safety-report.json') as f:
                    data = json.load(f)
                issues = len(data)
                print(f'  - Vulnerable packages: {issues}')
            except:
                print('  - No vulnerabilities found or error reading report')
            "
          fi

          # RÃ©sumÃ© pip-audit
          if [ -f pip-audit-report.json ]; then
            echo "ğŸ“Š pip-audit Results:"
            python -c "
            import json
            try:
                with open('pip-audit-report.json') as f:
                    data = json.load(f)
                issues = len(data.get('vulnerabilities', []))
                print(f'  - Vulnerabilities: {issues}')
            except:
                print('  - No vulnerabilities found or error reading report')
            "
          fi

      - name: ğŸ¯ Security Score
        run: |
          echo "ğŸ¯ SECURITY SCORE CALCULATION"
          echo "============================"

          SCORE=100

          # DÃ©crÃ©menter pour chaque problÃ¨me
          if [ -f bandit-report.json ]; then
            CRITICAL=$(python -c "
            import json
            try:
                with open('bandit-report.json') as f:
                    data = json.load(f)
                critical = sum(1 for r in data.get('results', []) if r.get('issue_severity') == 'HIGH')
                print(critical)
            except:
                print(0)
            ")
            SCORE=$((SCORE - CRITICAL * 10))
          fi

          if [ -f safety-report.json ]; then
            VULNS=$(python -c "
            import json
            try:
                with open('safety-report.json') as f:
                    data = json.load(f)
                print(len(data))
            except:
                print(0)
            ")
            SCORE=$((SCORE - VULNS * 5))
          fi

          # Score minimum de 0
          if [ $SCORE -lt 0 ]; then
            SCORE=0
          fi

          echo "ğŸ”’ Security Score: $SCORE/100"

          # DÃ©finir le statut selon le score
          if [ $SCORE -lt 70 ]; then
            echo "âŒ Security score too low ($SCORE/100)"
            exit 1
          elif [ $SCORE -lt 90 ]; then
            echo "âš ï¸ Security score acceptable but needs improvement ($SCORE/100)"
          else
            echo "âœ… Excellent security score ($SCORE/100)"
          fi

  dependency-update-check:
    name: ğŸ“¦ Dependency Update Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Check Python dependencies
        run: |
          pip install pip-check-updates
          pcu --version

          echo "ğŸ“‹ Checking for outdated Python packages..."
          pcu --dry-run requirements.txt > dependency-updates.txt || true

          echo "ğŸ“Š Dependency Update Summary:"
          cat dependency-updates.txt || echo "No updates available"

      - name: ğŸ“¦ Check Node.js dependencies
        if: hashFiles('package.json') != ''
        run: |
          echo "ğŸ“‹ Checking for outdated Node.js packages..."
          npm outdated --json > npm-outdated.json || true

          echo "ğŸ“Š Node.js Dependency Update Summary:"
          cat npm-outdated.json || echo "No updates available"

      - name: ğŸ“Š Upload Dependency Reports
        uses: actions/upload-artifact@v3
        with:
          name: dependency-reports
          path: |
            dependency-updates.txt
            npm-outdated.json
          retention-days: 7
