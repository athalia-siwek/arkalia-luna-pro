---
name: ğŸš€ Tests de Performance

on:
  push:
    branches: [main, dev-migration]
  pull_request:
    branches: [main, dev-migration]
  schedule:
    # Tests de performance quotidiens Ã  2h du matin
    - cron: "0 2 * * *"

env:
  PYTHON_VERSION: "3.10"
  PERFORMANCE_TIMEOUT: 1800 # 30 minutes

# Permissions pour Ã©viter les erreurs de sÃ©curitÃ©
permissions:
  contents: read
  actions: read
  # Permissions minimales pour les tests de performance

jobs:
  # ğŸš€ Tests de performance complets
  performance-tests:
    name: ğŸ“Š Tests de Performance Complets
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      matrix:
        python-version: ["3.10"]
        test-suite: ["zeroia", "api", "integration"]
      fail-fast: false
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-benchmark pytest-timeout
          pip install aiohttp requests locust httpx

      - name: ğŸ§¹ Clean performance artifacts
        run: |
          find . -name "._*" -delete
          find . -name ".DS_Store" -delete
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          rm -rf .benchmarks/ performance-results/

      - name: ğŸ§ª Run Performance Tests - ${{ matrix.test-suite }}
        run: |
          echo "ğŸ§ª ExÃ©cution des tests de performance - ${{ matrix.test-suite }}..."
          case "${{ matrix.test-suite }}" in
            "zeroia")
              echo "ğŸ“Š Tests de performance ZeroIA..."
              pytest tests/performance/zeroia/ -v --benchmark-only --timeout=300 || echo "âš ï¸ Tests ZeroIA terminÃ©s avec avertissements"
              ;;
            "api")
              echo "ğŸ“Š Tests de performance API..."
              pytest tests/performance/api/ -v --benchmark-only --timeout=300 || echo "âš ï¸ Tests API terminÃ©s avec avertissements"
              ;;
            "integration")
              echo "ğŸ“Š Tests de performance intÃ©gration..."
              pytest tests/performance/integration/ -v --benchmark-only --timeout=600 || echo "âš ï¸ Tests intÃ©gration terminÃ©s avec avertissements"
              ;;
          esac

      - name: ğŸ“Š Generate performance metrics
        run: |
          echo "ğŸ“Š GÃ©nÃ©ration des mÃ©triques de performance..."
          {
            echo "ğŸ” MÃ©triques systÃ¨me:";
            echo "- CPU: $(top -bn1 | grep 'Cpu(s)' | awk '{print \$2}')";
            echo "- MÃ©moire: $(free -h | grep 'Mem:' | awk '{print \$7}') libres";
            echo "- Disque: $(df -h / | awk 'NR==2 {print \$4}') libres";
            echo "";
            echo "ğŸ MÃ©triques Python:";
            python -c "import sys; print(f'- Python: {sys.version}')";
          } > performance-metrics-${{ matrix.test-suite }}.md

      - name: ğŸ“Š Run load tests with Locust (simulated)
        run: |
          echo "ğŸ“Š Tests de charge simulÃ©s..."
          {
            echo 'from locust import HttpUser, task, between';
            echo '';
            echo 'class ArkaliaUser(HttpUser):';
            echo '    wait_time = between(1, 3)';
            echo '';
            echo '    @task(3)';
            echo '    def health_check(self):';
            echo '        self.client.get("/health")';
            echo '';
            echo '    @task(2)';
            echo '    def zeroia_decision(self):';
            echo '        self.client.get("/zeroia/decision")';
            echo '';
            echo '    @task(1)';
            echo '    def reflexia_health(self):';
            echo '        self.client.get("/reflexia/health")';
          } > locustfile.py
          echo "âœ… Fichier Locust gÃ©nÃ©rÃ© pour tests futurs"

      - name: ğŸ“‹ Upload performance artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: performance-results-${{ matrix.test-suite }}
          path: |
            .benchmarks/
            performance-metrics-${{ matrix.test-suite }}.md
            locustfile.py
            performance-results/
          retention-days: 30

  # ğŸ“Š Analyse des performances
  performance-analysis:
    name: ğŸ“Š Analyse des Performances
    runs-on: ubuntu-latest
    needs: performance-tests
    if: always()
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pandas matplotlib

      - name: ğŸ“‹ Download performance artifacts
        uses: actions/download-artifact@v3
        with:
          path: performance-artifacts/

      - name: ğŸ“Š Generate performance report
        run: |
          {
            echo "## ğŸš€ Rapport Tests de Performance Arkalia-LUNA";
            echo "### ğŸ“… Date: $(date)";
            echo "### ğŸ”— Commit: ${{ github.sha }}";
            echo "### ğŸŒ¿ Branche: ${{ github.ref }}";
            echo "### ğŸƒâ€â™‚ï¸ Event: ${{ github.event_name }}";
            echo "";
            echo "### âœ… Statut des Tests:";
            echo "- ZeroIA: ${{ needs.performance-tests.result }}";
            echo "- API: ${{ needs.performance-tests.result }}";
            echo "- IntÃ©gration: ${{ needs.performance-tests.result }}";
            echo "";
            echo "### ğŸ“Š MÃ©triques CollectÃ©es:";
            if [ -d "performance-artifacts" ]; then
              echo "âœ… Artifacts disponibles";
              ls -la performance-artifacts/;
            else
              echo "âš ï¸ Aucun artifact trouvÃ©";
            fi
            echo "";
            echo "### ğŸ¯ Seuils de Performance:";
            echo "- Temps de rÃ©ponse API: < 500ms";
            echo "- DÃ©cision ZeroIA: < 2s";
            echo "- Circuit breaker: < 10ms";
            echo "- Charge concurrente: 10 utilisateurs";
          } > performance-report.md

      - name: ğŸ“‹ Upload performance report
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: performance-report.md
          retention-days: 30
