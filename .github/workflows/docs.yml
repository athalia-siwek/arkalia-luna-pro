---
name: ğŸ“˜ Deploy Documentation

on:
  push:
    branches: [main, develop, dev-migration, refonte-stable]
  pull_request:
    branches: [main, develop, dev-migration, refonte-stable]

permissions:
  contents: write  # â¬…ï¸ Autorise le push sur gh-pages via le GITHUB_TOKEN
  pages: write
  id-token: write

env:
  PYTHON_VERSION: "3.10"

jobs:
  # ğŸ” Validation de la documentation
  validate-docs:
    name: ğŸ” Validation Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Installer les dÃ©pendances
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install mkdocs mkdocs-material mkdocs-minify-plugin

      - name: ğŸ§¹ Clean generated files
        run: |
          find . -name "._*" -delete
          find . -name ".DS_Store" -delete
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

      - name: ğŸ•µï¸ Validate mkdocs configuration
        run: |
          echo "ğŸ” Validation de la configuration MkDocs..."
          if [ -f "mkdocs.yml" ]; then
            echo "âœ… mkdocs.yml trouvÃ©"
            mkdocs build --strict || (echo "âŒ mkdocs.yml invalide" && exit 1)
          else
            echo "âŒ mkdocs.yml manquant"
            exit 1
          fi

      - name: ğŸ” Check documentation structure
        run: |
          echo "ğŸ” VÃ©rification de la structure de documentation..."

          # VÃ©rification des dossiers critiques
          required_dirs=("docs" "site")

          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir trouvÃ©"
            else
              echo "âš ï¸ $dir manquant"
            fi
          done

          # VÃ©rification des fichiers critiques
          if [ -f "docs/README.md" ]; then
            echo "âœ… docs/README.md trouvÃ©"
          else
            echo "âš ï¸ docs/README.md manquant"
          fi

      - name: ğŸ” Validate markdown files
        run: |
          echo "ğŸ” Validation des fichiers Markdown..."

          # VÃ©rification basique des fichiers markdown
          find docs/ -name "*.md" -exec echo "ğŸ“„ {}" \;

          # Comptage des fichiers
          md_count=$(find docs/ -name "*.md" | wc -l)
          echo "ğŸ“Š Nombre de fichiers Markdown: $md_count"

  # ğŸ“˜ Build de la documentation
  build-docs:
    name: ğŸ“˜ Build Documentation
    runs-on: ubuntu-latest
    needs: validate-docs
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Installer les dÃ©pendances
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install mkdocs mkdocs-material mkdocs-minify-plugin

      - name: ğŸ§¹ Clean build artifacts
        run: |
          find . -name "._*" -delete
          find . -name ".DS_Store" -delete
          rm -rf site/ .cache/

      - name: ğŸ“˜ Build documentation
        run: |
          echo "ğŸ“˜ Construction de la documentation..."
          mkdocs build --clean --strict || (echo "âŒ Ã‰chec de la construction" && exit 1)

          echo "ğŸ“Š Statistiques de build:"
          echo "ğŸ“ Fichiers gÃ©nÃ©rÃ©s: $(find site/ -type f | wc -l)"
          echo "ğŸ“„ Pages HTML: $(find site/ -name "*.html" | wc -l)"
          echo "ğŸ“¦ Taille totale: $(du -sh site/ | cut -f1)"

      - name: ğŸ” Validate built documentation
        run: |
          echo "ğŸ” Validation de la documentation construite..."

          # VÃ©rification des fichiers critiques
          if [ -f "site/index.html" ]; then
            echo "âœ… site/index.html gÃ©nÃ©rÃ©"
          else
            echo "âŒ site/index.html manquant"
            exit 1
          fi

          # VÃ©rification des assets
          if [ -d "site/assets" ]; then
            echo "âœ… Assets gÃ©nÃ©rÃ©s"
          else
            echo "âš ï¸ Assets manquants"
          fi

      - name: ğŸ“‹ Upload built documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation-build
          path: site/
          retention-days: 7

  # ğŸš€ DÃ©ploiement de la documentation
  deploy-docs:
    name: ğŸš€ Deploy Documentation
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.event_name == 'push'
    timeout-minutes: 10
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ğŸ“¥ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Installer les dÃ©pendances
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install mkdocs mkdocs-material mkdocs-minify-plugin

      - name: ğŸ“‹ Download built documentation
        uses: actions/download-artifact@v4
        with:
          name: documentation-build
          path: site/

      - name: ğŸ” Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“˜ DÃ©ployer la documentation avec mkdocs
        id: deployment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ DÃ©ploiement de la documentation..."

          # Configuration Git pour le dÃ©ploiement
          git config --global user.email "ci@arkalia.ai"
          git config --global user.name "arkalia-bot"

          # DÃ©ploiement avec gestion d'erreur
          if mkdocs gh-deploy --force --remote-branch gh-pages --remote-name origin; then
            echo "âœ… DÃ©ploiement rÃ©ussi"
            echo "page_url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_OUTPUT
          else
            echo "âŒ Ã‰chec du dÃ©ploiement"
            exit 1
          fi

      - name: ğŸ¥ Health check documentation
        run: |
          echo "ğŸ¥ VÃ©rification de la documentation dÃ©ployÃ©e..."

          # Attendre que GitHub Pages soit disponible
          sleep 30

          # VÃ©rification avec retry
          for i in {1..10}; do
            if curl -f -s "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" > /dev/null; then
              echo "âœ… Documentation disponible"
              break
            else
              echo "â³ Tentative $i/10 - Documentation non disponible"
              sleep 30
            fi
          done

  # ğŸ“Š Rapport de dÃ©ploiement documentation
  docs-report:
    name: ğŸ“Š Rapport Documentation
    runs-on: ubuntu-latest
    needs: [validate-docs, build-docs, deploy-docs]
    if: always()
    timeout-minutes: 5
    steps:
      - name: ğŸ“¥ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ“Š Generate documentation report
        run: |
          echo "## ğŸ“˜ Rapport DÃ©ploiement Documentation Arkalia-LUNA" > docs-report.md
          echo "### ğŸ“… Date: $(date)" >> docs-report.md
          echo "### ğŸ”— Commit: ${{ github.sha }}" >> docs-report.md
          echo "### ğŸŒ¿ Branche: ${{ github.ref }}" >> docs-report.md
          echo "### ğŸƒâ€â™‚ï¸ Event: ${{ github.event_name }}" >> docs-report.md
          echo "" >> docs-report.md
          echo "### âœ… Statut des Ã©tapes:" >> docs-report.md
          echo "- Validation: ${{ needs.validate-docs.result }}" >> docs-report.md
          echo "- Build: ${{ needs.build-docs.result }}" >> docs-report.md
          echo "- DÃ©ploiement: ${{ needs.deploy-docs.result }}" >> docs-report.md
          echo "" >> docs-report.md
          echo "### ğŸŒ URL Documentation:" >> docs-report.md
          echo "- Production: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> docs-report.md
          echo "" >> docs-report.md
          echo "### ğŸ“Š Statistiques:" >> docs-report.md
          echo "- Fichiers Markdown: $(find docs/ -name '*.md' | wc -l)" >> docs-report.md
          echo "- Pages gÃ©nÃ©rÃ©es: $(find site/ -name '*.html' | wc -l 2>/dev/null || echo 'N/A')" >> docs-report.md

      - name: ğŸ“‹ Upload documentation report
        uses: actions/upload-artifact@v4
        with:
          name: docs-report
          path: docs-report.md
          retention-days: 90

      - name: ğŸš¨ Notify on documentation failure
        if: failure()
        run: |
          echo "âŒ DÃ©ploiement documentation a Ã©chouÃ© sur ${{ github.ref }}"
          echo "ğŸ”— Voir les dÃ©tails: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
