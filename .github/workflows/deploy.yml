---
name: ğŸš€ Deploy Arkalia-LUNA

on:
  push:
    branches: [ main, develop, dev-migration, refonte-stable ]
  pull_request:
    branches: [ main, develop, dev-migration, refonte-stable ]

env:
  PYTHON_VERSION: "3.10"
  DOCKER_REGISTRY: "ghcr.io"
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

# Permissions pour Ã©viter les erreurs de sÃ©curitÃ©
permissions:
  contents: read
  packages: write
  actions: read

jobs:
  # ğŸ” Validation prÃ©-dÃ©ploiement
  pre-deploy-validation:
    name: ğŸ” Validation PrÃ©-DÃ©ploiement
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install mkdocs mkdocs-material

      - name: ğŸ” Validate MkDocs configuration
        run: |
          echo "ğŸ” Validation de la configuration MkDocs..."
          if [ -f "mkdocs.yml" ]; then
            echo "âœ… mkdocs.yml trouvÃ©"
            mkdocs build --strict || (echo "âŒ mkdocs.yml invalide" && exit 1)
            echo "âœ… Configuration MkDocs valide"
          else
            echo "âŒ mkdocs.yml manquant"
            exit 1
          fi

      - name: ğŸ” Validate Dockerfiles
        run: |
          echo "ğŸ” Validation des Dockerfiles..."
          chmod +x scripts/validate-dockerfiles.sh
          ./scripts/validate-dockerfiles.sh

      - name: ğŸ•µï¸ Validate docker-compose
        run: |
          echo "ğŸ” Validation docker-compose.yml..."
          if [ -f "docker-compose.yml" ]; then
            echo "âœ… docker-compose.yml trouvÃ©"
            docker compose config --quiet || (echo "âŒ docker-compose.yml invalide" && exit 1)
          else
            echo "âŒ docker-compose.yml manquant"
            exit 1
          fi

      - name: ğŸ” Validate environment files
        run: |
          echo "ğŸ” Validation des fichiers d'environnement..."

          # VÃ©rification des variables critiques
          if [ -f ".env.example" ]; then
            echo "âœ… .env.example trouvÃ©"
          else
            echo "âš ï¸ .env.example manquant"
          fi

  # ğŸ³ Construction Docker
  build:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: pre-deploy-validation
    if: github.event_name == 'push'
    timeout-minutes: 30
    strategy:
      matrix:
        image: [zeroia, reflexia, sandozia, assistantia]
        include:
          - image: zeroia
            dockerfile: Dockerfile.zeroia
          - image: reflexia
            dockerfile: Dockerfile-reflexia
          - image: sandozia
            dockerfile: Dockerfile.sandozia
          - image: assistantia
            dockerfile: Dockerfile.assistantia
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:v0.12.0

      - name: ğŸ” Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ³ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.image }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.image }}-

      - name: ğŸ³ Build and push ${{ matrix.image }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ matrix.dockerfile }}
          push: true
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/${{ matrix.image }}:latest
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/${{ matrix.image }}:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/${{ matrix.image }}:v${{ github.run_number }}
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: ğŸ”„ Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  # ğŸ§ª Tests E2E post-build
  e2e:
    name: ğŸ§ª Tests E2E Post-Build
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    timeout-minutes: 45
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest pytest-asyncio requests

      - name: ğŸ³ Start services for E2E tests
        run: |
          echo "ğŸš€ DÃ©marrage des services pour tests E2E..."
          docker compose up -d --remove-orphans
          sleep 60

      - name: ğŸ¥ Health check services
        run: |
          echo "ğŸ¥ VÃ©rification santÃ© des services..."

          # VÃ©rification avec retry
          for service in "8000/health" "8000/zeroia/health" "8000/reflexia/health"; do
            echo "ğŸ” VÃ©rification $service..."
            for i in {1..10}; do
              if curl -f -s "http://localhost:$service" > /dev/null; then
                echo "âœ… $service disponible"
                break
              else
                echo "â³ Tentative $i/10 - $service non disponible"
                sleep 10
              fi
            done
          done

      - name: ğŸ§ª Run E2E tests
        run: |
          echo "ğŸ§ª ExÃ©cution des tests E2E..."
          if [ -d "tests/e2e" ]; then
            pytest tests/e2e/ -v --tb=short --timeout=300 || echo "âš ï¸ Tests E2E terminÃ©s avec avertissements"
          else
            echo "ğŸ“ Dossier tests/e2e non trouvÃ©"
          fi

      - name: ğŸ³ Stop services
        if: always()
        run: |
          echo "ğŸ›‘ ArrÃªt des services..."
          docker compose down --remove-orphans
          docker system prune -f

  # ğŸš€ DÃ©ploiement Staging
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [e2e]
    if: github.ref == 'refs/heads/dev-migration' && github.event_name == 'push'
    environment: staging
    timeout-minutes: 20
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to staging registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Deploy to staging server
        run: |
          echo "ğŸš€ DÃ©ploiement staging sur ${{ github.ref }}"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”— Commit: ${{ github.sha }}"

          # Ici vous ajouteriez vos commandes de dÃ©ploiement staging
          # Exemple avec SSH ou autre mÃ©thode
          # ssh user@staging-server "cd /app && docker compose pull && docker compose up -d"

          echo "âœ… DÃ©ploiement staging initiÃ©"

      - name: ğŸ¥ Health check staging
        run: |
          echo "ğŸ¥ VÃ©rification santÃ© staging..."

          # Attendre le dÃ©marrage
          sleep 30

          # Health checks avec retry
          for i in {1..10}; do
            if curl -f -s http://staging.arkalia.ai/health > /dev/null; then
              echo "âœ… Staging API disponible"
              break
            else
              echo "â³ Tentative $i/10 - Staging non disponible"
              sleep 10
            fi
          done

      - name: ğŸ“Š Staging smoke tests
        run: |
          echo "ğŸ“Š Tests de fumÃ©e staging..."

          # Tests basiques
          curl -f http://staging.arkalia.ai/health || exit 1
          curl -f http://staging.arkalia.ai/zeroia/health || echo "âš ï¸ ZeroIA staging non disponible"
          curl -f http://staging.arkalia.ai/reflexia/health || echo "âš ï¸ ReflexIA staging non disponible"

  # ğŸš€ DÃ©ploiement Production
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [e2e]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    timeout-minutes: 30
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to production registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Deploy to production server
        run: |
          echo "ğŸš€ DÃ©ploiement production sur ${{ github.ref }}"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”— Commit: ${{ github.sha }}"

          # Ici vous ajouteriez vos commandes de dÃ©ploiement production
          # Exemple avec blue-green deployment
          # ssh user@prod-server "cd /app && ./deploy.sh blue-green"

          echo "âœ… DÃ©ploiement production initiÃ©"

      - name: ğŸ¥ Health check production
        run: |
          echo "ğŸ¥ VÃ©rification santÃ© production..."

          # Attendre le dÃ©marrage
          sleep 45

          # Health checks avec retry
          for i in {1..15}; do
            if curl -f -s http://arkalia.ai/health > /dev/null; then
              echo "âœ… Production API disponible"
              break
            else
              echo "â³ Tentative $i/15 - Production non disponible"
              sleep 10
            fi
          done

      - name: ğŸ“Š Production smoke tests
        run: |
          echo "ğŸ“Š Tests de fumÃ©e production..."

          # Tests critiques
          curl -f http://arkalia.ai/health || exit 1
          curl -f http://arkalia.ai/zeroia/health || exit 1
          curl -f http://arkalia.ai/reflexia/health || exit 1

          # Tests de performance basiques
          response_time=$(curl -w "%{time_total}" -o /dev/null -s http://arkalia.ai/health)
          echo "â±ï¸ Temps de rÃ©ponse: ${response_time}s"

          if (( $(echo "$response_time > 2.0" | bc -l) )); then
            echo "âš ï¸ Temps de rÃ©ponse Ã©levÃ©: ${response_time}s"
          fi

      - name: ğŸ“Š Post-deployment monitoring
        run: |
          echo "ğŸ“Š Monitoring post-dÃ©ploiement..."

          # VÃ©rifications supplÃ©mentaires
          echo "ğŸ” VÃ©rification des mÃ©triques..."
          curl -s http://arkalia.ai/metrics | head -20 || echo "âš ï¸ MÃ©triques non disponibles"

          echo "ğŸ” VÃ©rification des logs..."
          # Ici vous pourriez vÃ©rifier les logs d'erreur

  # ğŸ”„ Rollback automatique
  rollback:
    name: ğŸ”„ Rollback Automatique
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: failure() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”„ Execute rollback
        run: |
          echo "ğŸ”„ ExÃ©cution du rollback automatique..."
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”— Commit: ${{ github.sha }}"

          # Ici vous ajouteriez votre logique de rollback
          # Exemple: revenir Ã  la version prÃ©cÃ©dente
          echo "âœ… Rollback initiÃ©"

      - name: ğŸ¥ Verify rollback
        run: |
          echo "ğŸ¥ VÃ©rification du rollback..."
          sleep 30

          # VÃ©rification que le rollback fonctionne
          if curl -f -s http://arkalia.ai/health > /dev/null; then
            echo "âœ… Rollback rÃ©ussi"
          else
            echo "âŒ Rollback Ã©chouÃ©"
            exit 1
          fi

  # ğŸ“Š Rapport de dÃ©ploiement
  deployment-report:
    name: ğŸ“Š Rapport de DÃ©ploiement
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production, rollback]
    if: always()
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“Š Generate deployment report
        run: |
          echo "## ğŸš€ Rapport de DÃ©ploiement Arkalia-LUNA" > deployment-report.md
          echo "### ğŸ“… Date: $(date)" >> deployment-report.md
          echo "### ğŸ”— Commit: ${{ github.sha }}" >> deployment-report.md
          echo "### ğŸŒ¿ Branche: ${{ github.ref }}" >> deployment-report.md
          echo "### ğŸƒâ€â™‚ï¸ Event: ${{ github.event_name }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### âœ… Statut des dÃ©ploiements:" >> deployment-report.md
          echo "- Staging: ${{ needs.deploy-staging.result }}" >> deployment-report.md
          echo "- Production: ${{ needs.deploy-production.result }}" >> deployment-report.md
          echo "- Rollback: ${{ needs.rollback.result }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "### ğŸ³ Images construites:" >> deployment-report.md
          echo "- zeroia: ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/zeroia:${{ github.sha }}" >> deployment-report.md
          echo "- reflexia: ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/reflexia:${{ github.sha }}" >> deployment-report.md
          echo "- sandozia: ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/sandozia:${{ github.sha }}" >> deployment-report.md
          echo "- assistantia: ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/assistantia:${{ github.sha }}" >> deployment-report.md

      - name: ğŸ“‹ Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md
          retention-days: 90

      - name: ğŸš¨ Notify on deployment failure
        if: failure()
        run: |
          echo "âŒ DÃ©ploiement a Ã©chouÃ© sur ${{ github.ref }}"
          echo "ğŸ”— Voir les dÃ©tails: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
