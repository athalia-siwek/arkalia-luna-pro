#!/usr/bin/env python3
"""
üåï G√©n√©rateur de Dashboard Grafana - Arkalia-LUNA Pro
Cr√©e un dashboard unifi√© avec toutes les m√©triques du syst√®me
"""

from core.ark_logger import ark_logger
import json
from pathlib import Path
from typing import Any


def create_arkalia_overview_dashboard() -> dict[str, Any]:
    """Cr√©e le dashboard unifi√© Arkalia-LUNA Pro"""

    dashboard: dict[str, Any] = {
        "annotations": {
            "list": [
                {
                    "builtIn": 1,
                    "datasource": "-- Grafana --",
                    "enable": True,
                    "hide": True,
                    "iconColor": "rgba(0, 211, 255, 1)",
                    "name": "Annotations & Alerts",
                    "type": "dashboard",
                }
            ]
        },
        "description": "üåï Dashboard Unifi√© Arkalia-LUNA Pro - Vue d'ensemble compl√®te du syst√®me",
        "editable": True,
        "gnetId": None,
        "graphTooltip": 0,
        "id": None,
        "links": [],
        "panels": [
            # Panel 1: Uptime Syst√®me
            {
                "datasource": "prometheus",
                "description": "√âtat g√©n√©ral du syst√®me Arkalia-LUNA",
                "fieldConfig": {
                    "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {"color": "red", "value": None},
                                {"color": "green", "value": 1},
                            ],
                        },
                    },
                    "overrides": [],
                },
                "gridPos": {"h": 8, "w": 6, "x": 0, "y": 0},
                "id": 1,
                "options": {
                    "colorMode": "value",
                    "graphMode": "area",
                    "justifyMode": "auto",
                    "orientation": "auto",
                    "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": False},
                    "textMode": "auto",
                },
                "pluginVersion": "10.0.0",
                "targets": [
                    {
                        "expr": "arkalia_system_uptime_seconds",
                        "interval": "",
                        "legendFormat": "Uptime",
                        "refId": "A",
                    }
                ],
                "title": "üïê Uptime Syst√®me",
                "type": "stat",
            },
            # Panel 2: CPU/RAM
            {
                "datasource": "prometheus",
                "description": "Utilisation CPU et RAM en temps r√©el",
                "fieldConfig": {
                    "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {
                            "axisLabel": "",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "line",
                            "fillOpacity": 10,
                            "gradientMode": "none",
                            "hideFrom": {"legend": False, "tooltip": False, "vis": False},
                            "lineInterpolation": "linear",
                            "lineWidth": 2,
                            "pointSize": 5,
                            "scaleDistribution": {"type": "linear"},
                            "showPoints": "never",
                            "spanNulls": False,
                            "stacking": {"group": "A", "mode": "none"},
                            "thresholdsStyle": {"mode": "off"},
                        },
                        "mappings": [],
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {"color": "green", "value": None},
                                {"color": "yellow", "value": 70},
                                {"color": "red", "value": 90},
                            ],
                        },
                        "unit": "percent",
                    },
                    "overrides": [],
                },
                "gridPos": {"h": 8, "w": 9, "x": 6, "y": 0},
                "id": 2,
                "options": {
                    "legend": {"calcs": [], "displayMode": "list", "placement": "bottom"},
                    "tooltip": {"mode": "single"},
                },
                "targets": [
                    {
                        "expr": "arkalia_reflexia_cpu_usage_percent",
                        "interval": "",
                        "legendFormat": "CPU %",
                        "refId": "A",
                    },
                    {
                        "expr": "arkalia_reflexia_ram_usage_percent",
                        "interval": "",
                        "legendFormat": "RAM %",
                        "refId": "B",
                    },
                ],
                "title": "üíª Utilisation CPU/RAM",
                "type": "timeseries",
            },
            # Panel 3: Latence
            {
                "datasource": "prometheus",
                "description": "Latence syst√®me et temps de r√©ponse",
                "fieldConfig": {
                    "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {
                            "axisLabel": "",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "line",
                            "fillOpacity": 10,
                            "gradientMode": "none",
                            "hideFrom": {"legend": False, "tooltip": False, "vis": False},
                            "lineInterpolation": "linear",
                            "lineWidth": 2,
                            "pointSize": 5,
                            "scaleDistribution": {"type": "linear"},
                            "showPoints": "never",
                            "spanNulls": False,
                            "stacking": {"group": "A", "mode": "none"},
                            "thresholdsStyle": {"mode": "off"},
                        },
                        "mappings": [],
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {"color": "green", "value": None},
                                {"color": "yellow", "value": 100},
                                {"color": "red", "value": 500},
                            ],
                        },
                        "unit": "ms",
                    },
                    "overrides": [],
                },
                "gridPos": {"h": 8, "w": 9, "x": 15, "y": 0},
                "id": 3,
                "options": {
                    "legend": {"calcs": [], "displayMode": "list", "placement": "bottom"},
                    "tooltip": {"mode": "single"},
                },
                "targets": [
                    {
                        "expr": "arkalia_reflexia_latency_ms",
                        "interval": "",
                        "legendFormat": "Latence Syst√®me",
                        "refId": "A",
                    },
                    {
                        "expr": "histogram_quantile(0.95, rate(arkalia_assistantia_response_time_seconds_bucket[5m])) * 1000",
                        "interval": "",
                        "legendFormat": "Temps R√©ponse AssistantIA (95e percentile)",
                        "refId": "B",
                    },
                ],
                "title": "‚ö° Latence & Temps de R√©ponse",
                "type": "timeseries",
            },
            # Panel 4: D√©cisions ZeroIA
            {
                "datasource": "prometheus",
                "description": "D√©cisions ZeroIA par minute",
                "fieldConfig": {
                    "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {
                            "axisLabel": "",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "line",
                            "fillOpacity": 10,
                            "gradientMode": "none",
                            "hideFrom": {"legend": False, "tooltip": False, "vis": False},
                            "lineInterpolation": "linear",
                            "lineWidth": 2,
                            "pointSize": 5,
                            "scaleDistribution": {"type": "linear"},
                            "showPoints": "never",
                            "spanNulls": False,
                            "stacking": {"group": "A", "mode": "none"},
                            "thresholdsStyle": {"mode": "off"},
                        },
                        "mappings": [],
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [{"color": "green", "value": None}],
                        },
                        "unit": "reqps",
                    },
                    "overrides": [],
                },
                "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
                "id": 4,
                "options": {
                    "legend": {"calcs": [], "displayMode": "list", "placement": "bottom"},
                    "tooltip": {"mode": "single"},
                },
                "targets": [
                    {
                        "expr": "rate(arkalia_zeroia_decisions_total[1m])",
                        "interval": "",
                        "legendFormat": "D√©cisions/min",
                        "refId": "A",
                    }
                ],
                "title": "üß† D√©cisions ZeroIA/min",
                "type": "timeseries",
            },
            # Panel 5: Score de Confiance
            {
                "datasource": "prometheus",
                "description": "Score de confiance des d√©cisions ZeroIA",
                "fieldConfig": {
                    "defaults": {
                        "color": {"mode": "thresholds"},
                        "mappings": [],
                        "max": 1,
                        "min": 0,
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {"color": "red", "value": None},
                                {"color": "yellow", "value": 0.3},
                                {"color": "green", "value": 0.7},
                            ],
                        },
                        "unit": "percentunit",
                    },
                    "overrides": [],
                },
                "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
                "id": 5,
                "options": {
                    "orientation": "auto",
                    "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": False},
                    "showThresholdLabels": False,
                    "showThresholdMarkers": True,
                },
                "pluginVersion": "10.0.0",
                "targets": [
                    {
                        "expr": "arkalia_zeroia_confidence_score",
                        "interval": "",
                        "legendFormat": "Confiance",
                        "refId": "A",
                    }
                ],
                "title": "üéØ Score de Confiance ZeroIA",
                "type": "gauge",
            },
            # Panel 6: Prompts AssistantIA
            {
                "datasource": "prometheus",
                "description": "Prompts trait√©s par AssistantIA et blocages de s√©curit√©",
                "fieldConfig": {
                    "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {
                            "axisLabel": "",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "bars",
                            "fillOpacity": 80,
                            "gradientMode": "none",
                            "hideFrom": {"legend": False, "tooltip": False, "vis": False},
                            "lineInterpolation": "linear",
                            "lineWidth": 1,
                            "pointSize": 5,
                            "scaleDistribution": {"type": "linear"},
                            "showPoints": "never",
                            "spanNulls": False,
                            "stacking": {"group": "A", "mode": "normal"},
                            "thresholdsStyle": {"mode": "off"},
                        },
                        "mappings": [],
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [{"color": "green", "value": None}],
                        },
                        "unit": "short",
                    },
                    "overrides": [],
                },
                "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
                "id": 6,
                "options": {
                    "legend": {"calcs": [], "displayMode": "list", "placement": "bottom"},
                    "tooltip": {"mode": "single"},
                },
                "targets": [
                    {
                        "expr": "rate(arkalia_assistantia_prompts_total[5m])",
                        "interval": "",
                        "legendFormat": "Prompts trait√©s/min",
                        "refId": "A",
                    },
                    {
                        "expr": "rate(arkalia_assistantia_security_blocks_total[5m])",
                        "interval": "",
                        "legendFormat": "Blocages s√©curit√©/min",
                        "refId": "B",
                    },
                ],
                "title": "üí¨ Prompts AssistantIA & S√©curit√©",
                "type": "timeseries",
            },
            # Panel 7: Erreurs par Module
            {
                "datasource": "prometheus",
                "description": "Erreurs syst√®me par module et type",
                "fieldConfig": {
                    "defaults": {
                        "color": {"mode": "palette-classic"},
                        "custom": {"hideFrom": {"legend": False, "tooltip": False, "vis": False}},
                        "mappings": [],
                        "unit": "short",
                    },
                    "overrides": [],
                },
                "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
                "id": 7,
                "options": {
                    "legend": {"displayMode": "list", "placement": "bottom"},
                    "pieType": "pie",
                    "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": False},
                    "tooltip": {"mode": "single"},
                },
                "targets": [
                    {
                        "expr": "arkalia_errors_total",
                        "interval": "",
                        "legendFormat": "{{module}} - {{error_type}}",
                        "refId": "A",
                    }
                ],
                "title": "üö® Erreurs par Module",
                "type": "piechart",
            },
        ],
        "refresh": "5s",
        "schemaVersion": 38,
        "style": "dark",
        "tags": ["arkalia", "luna", "monitoring", "overview"],
        "templating": {"list": []},
        "time": {"from": "now-1h", "to": "now"},
        "timepicker": {},
        "timezone": "",
        "title": "üåï Arkalia-LUNA Pro - Vue d'Ensemble",
        "uid": "arkalia-overview",
        "version": 1,
    }

    return dashboard


def main() -> None:
    """Fonction principale"""
    ark_logger.info("üåï G√©n√©ration du Dashboard Grafana Arkalia-LUNA Pro...", extra={"module": "scripts"})

    # Cr√©er le dashboard
    dashboard = create_arkalia_overview_dashboard()

    # Chemin de sortie
    output_path = Path("infrastructure/monitoring/grafana/dashboards/arkalia_overview.json")
    output_path.parent.mkdir(parents=True, exist_ok=True)

    # Sauvegarder le dashboard
    with open(output_path, "w", encoding="utf-8") as f:
        json.dump(dashboard, f, indent=2, ensure_ascii=False)

    ark_logger.info(f"‚úÖ Dashboard cr√©√©: {output_path}", extra={"module": "scripts"})
    ark_logger.info("üìä Panels inclus:", extra={"module": "scripts"})
    ark_logger.info("  ‚Ä¢ üïê Uptime Syst√®me", extra={"module": "scripts"})
    ark_logger.info("  ‚Ä¢ üíª Utilisation CPU/RAM", extra={"module": "scripts"})
    ark_logger.info("  ‚Ä¢ ‚ö° Latence & Temps de R√©ponse", extra={"module": "scripts"})
    ark_logger.info("  ‚Ä¢ üß† D√©cisions ZeroIA/min", extra={"module": "scripts"})
    ark_logger.info("  ‚Ä¢ üéØ Score de Confiance ZeroIA", extra={"module": "scripts"})
    ark_logger.info("  ‚Ä¢ üí¨ Prompts AssistantIA & S√©curit√©", extra={"module": "scripts"})
    ark_logger.info("  ‚Ä¢ üö® Erreurs par Module", extra={"module": "scripts"})


if __name__ == "__main__":
    main()
